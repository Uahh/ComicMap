<!DOCTYPE html>

<html style="height: 100%">
    <head>
        <meta charset="utf-8">
        <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script>
        <script type="text/javascript" src="../static/js/china_map.js"></script>
    </head>
    <body style="height: 100%; margin: 0">
        <div id="main" style="height: 100%"></div>
        <script type="text/javascript">
            const data2 = [
              { name: '海', value: 9 },
              { name: '海门', value: 9 }
            ];
            const geoCoordMap = {
              海: [121.15, 31.89],
              海门: [121.15, 32.89],
            };
            const convertData = function (temp) {
                var res = [];
                for (var i = 0; i < temp.length; i++) {
                    var geoCoord = geoCoordMap[temp[i].name];
                    if (geoCoord) {
                        res.push({
                            name: temp[i].name,
                            value: geoCoord.concat(temp[i].value)
                        });
                    }
                }
                return res;
            };
            var myChart = echarts.init(document.getElementById('main'));
            $.get('http://192.168.31.11:173/get_line_json',
            function(data) {
                myChart.hideLoading();
                function getCityCoord(idx) {
                    return [data.cities[idx][1], data.cities[idx][2]];
                }
                var routes = data.routes.map(function(line) {
                    return [getCityCoord(line[0]), getCityCoord(line[1])];
                });
                myChart.setOption(option = {
                    backgroundColor: '#4B0082',
                    title: {
                        text: 'ComicMap',
                        left: 'center',
                        textStyle: {
                            color: '#fff'
                        }
                    },
                    geo: {
                        map: 'china',
                        roam: true,
                        label: {
                            emphasis: {
                                show: false
                            }
                        },
                        silent: true,
                        left: 0,
                        right: 0,
                        silent: true,
                        roam: true,
                        itemStyle: {
                            normal: {
                                borderColor: '#FFFAF0',
                                color: '#F4A460'
                            }
                        }
                    },
                    series: [
                    {
                        type: 'lines',
                        coordinateSystem: 'geo',
                        data: routes,
                        large: true,
                        largeThreshold: 100,
                        lineStyle: {
                            opacity: 0.7,
                            width: 1,
                            curveness: 0.3
                        },
                        blendMode: 'lighter',
                    },
                    {
                        name: 'pm2.5',
                        type: 'scatter',
                        coordinateSystem: 'geo',
                        data: convertData(data2),
                        symbolSize: function (val) {
                            return val[2] / 10;
                        },
                        encode: {
                            value: 2
                        },
                        label: {
                            formatter: '{b}',
                            position: 'right',
                            show: false
                        },
                        emphasis: {
                            label: {
                              show: true
                            }
                        }
                    },
                    {
                        name: 'Top 5',
                        type: 'effectScatter',
                        coordinateSystem: 'geo',
                        data: convertData(
                            data2.sort(function (a, b) {
                                return b.value - a.value;
                            }).slice(0, 6)
                        ),
                        symbolSize: function (val) {
                            return val[2] / 10;
                        },
                        encode: {
                            value: 2
                        },
                        showEffectOn: 'render',
                        rippleEffect: {
                            brushType: 'stroke'
                        },
                        label: {
                            formatter: '{b}',
                            position: 'right',
                            show: true
                        },
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: '#333'
                        },
                        emphasis: {
                            scale: true
                        },
                        zlevel: 1
                    }]
                });
            })
        </script>
    </body>
</html>
